@page "/chess"
@using UltraChess.Blazor.Models

<h3>Chess</h3>

<div class="grid-container">
    @{
        foreach (var square in ChessBoard.squares)
        {
            <div id="@($"{square.Id}")" class="grid-item fill @(square.IsHighlighted ? "highlight" : square.IsLight ? "light" : "dark")" ondragover="event.preventDefault();" @ondrop="@(()=> Drop(square.Id))" >

                <div class="rank-text">@(square.File == 'a' ? square.Rank.ToString() : "")</div>
                <div class="file-text">@(square.Rank == '1' ? square.File.ToString() : "")</div>
                @{
                    if (square.PieceId != 0)
                    {
                        <img id="@($"{square.File}.{square.Rank}-image")" src="@(ChessBoard.pieces[square.PieceId].Image)" @ondrag="@(()=> StartDrag(square.Id))" ondrop="event.preventDefault();" />
                    }
                }
            </div>
        }
    }
</div>


@code {
    private ChessBoard ChessBoard = new ChessBoard("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");
    private int FromSquareId;

    void StartDrag(int fromSquareId)
    {
        FromSquareId = fromSquareId;
        var fromSquare = ChessBoard.squares[FromSquareId];
        if (ChessBoard.IsWhiteTurn)
        {
            if(ChessBoard.pieces[fromSquare.PieceId].IsWhite == true)
            {
                ChessBoard.HighlightLegalMoves(fromSquareId);
            }
        }
        else
        {
            if (ChessBoard.pieces[fromSquare.PieceId].IsWhite == false)
            {
                ChessBoard.HighlightLegalMoves(fromSquareId);
            }
        }
    }

    void Drop(int toSquareId)
    {
        if (ChessBoard.pieces[ChessBoard.squares[FromSquareId].PieceId].IsWhite)
        {
            if (ChessBoard.IsWhiteTurn)
            {
                var moveMade = ChessBoard.Move(FromSquareId, toSquareId);
                if (moveMade)
                {
                    ChessBoard.IsWhiteTurn = false;
                }
            }
        }
        else
        {
            if (!ChessBoard.IsWhiteTurn)
            {
                var moveMade = ChessBoard.Move(FromSquareId, toSquareId);
                if (moveMade)
                {
                    ChessBoard.IsWhiteTurn = true;
                }
            }
        }
    }
}
